
<%- include('partials/header.ejs'); %>

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
	<symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
		<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
	</symbol>
	<symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
		<path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
	</symbol>
</svg>

<main class="container">
	<div class="py-3 py-md-5 pb-md-2">
		<h2><%- combines.season; %>Combines Overview</h2>
		<p class="lead">
			View all the players that have played in this combine and how well they
			did during the combine.
		</p>
	</div>

	<div class="row">

		<div class="col-12 col-sm-12 col-md-12 col-lg-12">
			<div class="mb-3 row">
				<div class="col-6 col-lg-4 h3 fw-bolder text-success">Combine Tiermaker</div>
			</div>

			<%
				const limits = {
					50: false,
					100: false,
					250: false,
					500: false,
					1500: false,
				};
				if ( limit in limits ) {
					limits[limit] = true;
				}
				const cols = {
					't.rsc_id': '?order=rsc_id',
					't.name': '?order=name',
					't.tier': '?order=tier',
					't.base_mmr': '?order=base_mmr',
					't.effective_mmr': '?order=effective_mmr',
					't.current_mmr': '?order=current_mmr',
					't.count': '?order=count',
					't.keeper': '?order=keeper',
					't.wins': '?order=wins',
					't.losses': '?order=losses',
					't.win_percentage': '?order=win_percentage',
				};
				const arrows = {
					't.rsc_id': '',
					't.name': '',
					't.tier': '',
					't.base_mmr': '',
					't.effective_mmr': '',
					't.current_mmr': '',
					't.count': '',
					't.keeper': '',
					't.wins': '',
					't.losses': '',
					't.win_percentage': '',
				};
				if ( order in cols && dir ) {
					if ( dir === 'ASC' ) {
						cols[order] = cols[order] + '&dir=down';
						arrows[order] = '<i class="fas fa-arrow-down"></i>';
					} else if ( dir === 'DESC' ) {
						cols[order] = cols[order] + '&dir=up';
						arrows[order] = '<i class="fas fa-arrow-up"></i>';
					}
				}

				const query = new URLSearchParams({
					limit: limit,
					dir: dir,
					order: order,
				});
			%>
			<div class="row">
				<div class="col-12 col-md-3">
					<select name="limit" id="limit" onchange="set_page_size(this);">
						<% 
							for ( let lim in limits ) {
						%>
						<option value="<%- lim %>" <%- limits[lim] ? 'selected' : ''; %>><%- lim; %></option>
						<%
							}
						%>
					</select>
				</div>
				<div class="col-12 col-md-7">
				</div>
				<div class="col-12 col-md-2">
					<a href="/combines/history">
						<i class="fas fa-file-spreadsheet"></i>
					</a>
				</div>
			</div>
			<div class="mb-3">
				<table class="table table-hover">
					<thead>
						<tr>
							<th></th>
							<th class="text-center">
								<a href="<%- cols['t.rsc_id']; %>">
									RSC ID
								</a>
								<%- arrows['t.rsc_id']; %>
							</th>
							<th class="text-center">
								<a href="<%- cols['t.name']; %>">
									Player Name
								</a>
								<%- arrows['t.name']; %>
							</th>
							<th class="text-center">
								<a href="<%- cols['t.tier']; %>">
									Initial Tier
								</a>
								<%- arrows['t.tier']; %>
							</th>
							<th class="text-center">
								<a href="<%- cols['t.base_mmr']; %>">
									Base MMR
								</a>
								<%- arrows['t.base_mmr']; %>
							</th>
							<th class="text-center">
								<a href="<%- cols['t.effective_mmr']; %>">
									Effective MMR
								</a>
								<%- arrows['t.effective_mmr']; %>
							</th>
							<th class="text-center">
								<a href="<%- cols['t.mmr_delta']; %>">
									&Delta;
								</a>
								<%- arrows['t.mmr_delta']; %>
							</th>
							<th class="text-center">
								<a href="<%- cols['t.current_mmr']; %>">
									Combines MMR
								</a>
								<%- arrows['t.current_mmr']; %>
							</th>
							<th class="text-center">
								Combine Tier
							</th>
							<th class="text-center">
								<a href="<%- cols['t.wins']; %>">
									Record
								</a>
								<%- arrows['t.wins']; %>
							</th>
							<th class="text-center">
								<a href="<%- cols['t.win_percentage']; %>">
									W%
								</a>
								<%- arrows['t.win_percentage']; %>
							</th>
							<th></th>
						</tr>
					</thead>
					<tbody>

					<% 
						const stat_colors = {
							'great': 'text-success',
							'ok': 'text-info',
							'neutral': 'text-warning',
							'bad': 'text-danger',
							'none': 'text-muted',
						};
						let analysis = 'none';
						if ( Object.keys(players).length ) {
							for ( const rsc_id in players ) {
								const p = players[rsc_id];
								if ( p.win_percentage > 60 ) {
									analysis = 'great';
								} else if ( p.win_percentage > 52 ) {
									analysis = 'ok';
								} else if ( p.win_percentage > 45 ) {
									analysis = 'neutral';
								} else if ( p.win_percentage > 20 ) {
									analysis = 'bad';
								} else {
									analysis = 'none';
								}

					%>
						<tr>
							<td class="text-muted">
								<%- p.num; %>
							</td>
							<td class="text-left">
								<a href="/player/<%= rsc_id; %>">
									<%- rsc_id %>
								</a>
							</td>
							<td class="fw-bolder">
								<a href="/player/<%= rsc_id; %>"><%= p.name; %></a>
							</td>
							<td class="text-start bg-<%- p.tier; %>">
								<%- p.tier; %>
							</td>
							<td class="text-end">
								<%- p.base_mmr; %>
							</td>
							<td class="text-end">
								<%- p.effective_mmr; %>
							</td>
							<td class="text-center">
								<span 
									class="fw-bold <%- 
										p.mmr_delta > 0 ? 
											'text-success' : 
											p.mmr_delta === 0 ? 
												'text-muted' : 'text-danger'; 
									%>"
									title="<%= p.effective_mmr; %>"
									>
									<%= p.mmr_delta; %>
								</span>
							</td>
							<td class="text-center">
								<span 
									class="fw-bold <%- 
										p.mmr_delta > 0 ? 
											'text-success' : 
											p.mmr_delta === 0 ? 
												'text-muted' : 'text-danger'; 
									%>"
									title="<%= p.effective_mmr; %>"
									>
									<%= p.current_mmr; %>
								</span>
							</td>
							<td class="text-start bg-<%- p.combines_tier; %>">
								<%- p.combines_tier; %>
							</td>
							<td class="text-right">
								<span class="text-success fw-bold"><%= p.wins; %></span> /
								<span class="text-red fw-bold"><%= p.losses; %></span>
							</td>
							<td class="text-center">
								<span class="<%- stat_colors[analysis]; %> fw-bold">
									<%= p.win_percentage; %>%
								</span>
							</td>
						</tr>

					<% 
							} // end of loop
						} else {
					%>

						<tr><td colspan="12"><em>No players?</em></td></tr>

					<%
						}
					%>

					</tbody>
				</table>

				<nav aria-label="...">
					<ul class="pagination">
						<li class="page-item <%- page === 1 ? 'disabled' : ''; %>">
							<a class="page-link" href="#" tabindex="-1">Previous</a>
						</li>
						<li class="page-item"><a class="page-link" href="#">1</a></li>
						<li class="page-item active">
							<a class="page-link" href="#">2 <span class="sr-only">(current)</span></a>
						</li>
						<li class="page-item"><a class="page-link" href="#">3</a></li>
						<li class="page-item">
							<a class="page-link" href="?<%- query_params.toString(); %>">Next</a>
						</li>
					</ul>
				</nav>

			</div>

		</div>

	</div>

</main>

<%- include('partials/footer.ejs'); %>
