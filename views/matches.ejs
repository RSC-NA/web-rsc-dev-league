
<%- include('partials/header.ejs'); %>

<main class="container">
	<div class="py-5">
		<h2>Dev League Matches</h2>
		<p class="lead">
			Below is a list of all matches generated for Season <%= settings.season %>.
		</p>
	</div>

	<div class="row">
		<!-- <div class="col-md-4 order-md-2 mb-4">
			<h4 class="d-flex justify-content-between align-items-center mb-3">
				<span class="text-muted">Available Subs</span>
				<span class="badge badge-secondary badge-pill">3</span>
			</h4>
		</div> -->

		<!-- primary FA signup / team generation -->
		<div class="col-md-8 order-md-1">

			<%
				if ( matches && matches.length ) {

					let matchDay = '';

					for ( let i = 0; i < matches.length; i++ ) {
						if ( matches[i].match_day != matchDay ) {
							matchDay = matches[i].match_day;
			%>
			<h4 class="mb-3">MD <%= matchDay %></h4>
			<ul class="list-group mb-3">

			<%	
						} // end of MD check and list prep

						let homeTeam = matches[i].lobby_user.substring(3);
						let awayTeam = matches[i].lobby_pass.substring(3);
			%>
				<li class="list-group-item d-flex justify-content-between 1h-condensed">
					<h6 class="my-0"><a href="/match/<%= matches[i].id %>"><%= awayTeam %> @ <%= homeTeam %></a></h6>
				</li>
			<%
						if ( i == matches.length || matches[i+1].match_day != matchDay ) {
							// close out the list if we're done, or if the next result is a different MD.
			%>
			</ul>
			<%				
						}

					} // end of total loop
			%>

				

			<%		
				}
			%>

			<h4 class="mb-3">Matches By Day</h4>
			
			<% for ( let tier in signups ) { %>

			<div class="mb-3">
				<h5><%= tier %></h5>

				<% 
				let teamsBuilt = signups[tier]['fa'].length ? signups[tier]['fa'].filter(p => p.rostered ).length / 3 : null;
				if ( signups[tier]['fa'].length ) { 
					let player_count = (signups[tier]['fa'].length) - (teamsBuilt * 3);
					if ( (player_count % 6 === 0) && ! teamsBuilt ) {
						// has enough players for team generation


				%>
				<form class="card p-2" method="post" action="/generate_team/<%= tier %>">
					<input type="hidden" name="player_count" id="<%= tier %>_player_count" value="<%= signups[tier]['fa'].length %>">
					<input type="hidden" name="season" id="<%= tier %>_season" value="<%= signups[tier]['season'] %>">
					<input type="hidden" name="match_day" id="<%= tier %>_match_day" value="<%= signups[tier]['match_day'] %>">
					
					<% 
						for ( let i = 0; i < signups[tier]['fa'].length; i++ ) {
							if ( signups[tier]['fa'][i].rostered ) {
								continue; // skip players on an FA league team already
							}
							let player = signups[tier]['fa'][i]; 
					%>
							
							<input type="hidden" name="player_id_<%= i %>" value="<%= player['player_id'] %>">
					<% 
						}
					%>
					<div class="input-group">
						<button type="submit" class="btn btn-primary">Generate <%= tier %> Teams</button>
					</div>
				</form>
				<%
					} else {
						// does not have enough players for team generation
				%>
				<form class="card p-2" action="#">
					<div class="input-group">
						<button type="submit" class="btn btn-secondary" disabled>Generate <%= tier %> Teams [<%= player_count %>/6]</button>
						<% if ( teamsBuilt ) { %>
						<span class="text-muted m-2"><%= teamsBuilt %> Teams Generated</span>
						<% } %>
					</div>
				</form>
				<%		
					}
				%>
				<ul class="list-group mb-3">

					<% 
						for ( let i = 0; i < signups[tier]['fa'].length; i++ ) {
							if ( signups[tier]['fa'][i].rostered ) {
								continue; // skip players on an FA league team already
							}
							let player = signups[tier]['fa'][i]; 
					%>

					<li class="list-group-item d-flex justify-content-between lh-condensed">
						<div>
							<h6 class="my-0"><%= player['name'] %></h6>
							<small class="text-muted"><%= player['status'] %> - <a href="/make_inactive/<%= player['id'] %>">Deactivate Sub</a></small>
						</div>
						<span class="text-muted"><%= player['mmr'] %> MMR</span>
					</li>

					<% } // end of player for loop %>

				</ul>

				<% } // end of signups check %>

			</div>

			<% } // end of tier loop %>

		</div>

	</div>

</main>

<%- include('partials/footer.ejs'); %>